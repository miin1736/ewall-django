# DigitalOcean App Platform 배포 설정

name: ewall-django
region: sgp  # Singapore (한국과 가까움)

services:
- name: web
  github:
    repo: yourusername/ewall-django
    branch: main
    deploy_on_push: true
  
  build_command: |
    pip install -r requirements.txt
    python manage.py collectstatic --noinput
  
  run_command: gunicorn config.wsgi:application --bind 0.0.0.0:8000 --workers 2
  
  envs:
  - key: DJANGO_ENV
    value: production
  - key: SECRET_KEY
    type: SECRET
    value: ${SECRET_KEY}
  - key: DATABASE_URL
    value: ${db.DATABASE_URL}
  - key: REDIS_URL
    value: ${redis.REDIS_URL}
  - key: CELERY_BROKER_URL
    value: ${redis.REDIS_URL}
  - key: CELERY_RESULT_BACKEND
    value: ${redis.REDIS_URL}
  
  http_port: 8000
  instance_count: 1
  instance_size_slug: basic-xxs  # $12/month

- name: celery-worker
  github:
    repo: yourusername/ewall-django
    branch: main
  
  run_command: celery -A config worker -l info
  
  envs:
  - key: DJANGO_ENV
    value: production
  - key: DATABASE_URL
    value: ${db.DATABASE_URL}
  - key: REDIS_URL
    value: ${redis.REDIS_URL}
  
  instance_count: 1
  instance_size_slug: basic-xxs

- name: celery-beat
  github:
    repo: yourusername/ewall-django
    branch: main
  
  run_command: celery -A config beat -l info
  
  envs:
  - key: DJANGO_ENV
    value: production
  - key: DATABASE_URL
    value: ${db.DATABASE_URL}
  - key: REDIS_URL
    value: ${redis.REDIS_URL}
  
  instance_count: 1
  instance_size_slug: basic-xxs

databases:
- name: db
  engine: PG
  version: "15"
  production: false  # true로 변경하면 $15/month
  
- name: redis
  engine: REDIS
  version: "7"
  production: false

static_sites:
- name: static
  build_command: python manage.py collectstatic --noinput
  output_dir: /staticfiles
