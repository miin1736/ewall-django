{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ product.title }} - {{ product.brand.name }} {{ meta.title }}{% endblock %}

{% block meta %}
<meta name="description" content="{{ meta.description }}">
<meta name="keywords" content="{{ meta.keywords }}">
<meta property="og:title" content="{{ meta.og_title }}">
<meta property="og:description" content="{{ meta.og_description }}">
<meta property="og:image" content="{{ product.image_url }}">
<meta property="og:type" content="product">

<script type="application/ld+json">
{{ schema|safe }}
</script>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Breadcrumb -->
    <nav class="text-sm mb-6">
        <a href="{% url 'home' %}" class="text-blue-600 hover:underline">í™ˆ</a>
        <span class="mx-2">/</span>
        <a href="{% url 'landing-page' product.brand.slug product.category.slug %}" class="text-blue-600 hover:underline">
            {{ product.brand.name }} {{ product.category.name }}
        </a>
        <span class="mx-2">/</span>
        <span class="text-gray-600">{{ product.title|truncatewords:5 }}</span>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
        <!-- ìƒí’ˆ ì´ë¯¸ì§€ -->
        <div class="bg-white rounded-lg p-6 shadow">
            {% if product.image_url %}
            <img src="{{ product.image_url }}" 
                 alt="{{ product.title }}" 
                 class="w-full h-auto rounded-lg">
            {% else %}
            <div class="w-full h-96 bg-gray-200 rounded-lg flex items-center justify-center">
                <span class="text-gray-400">ì´ë¯¸ì§€ ì—†ìŒ</span>
            </div>
            {% endif %}
        </div>

        <!-- ìƒí’ˆ ì •ë³´ -->
        <div class="bg-white rounded-lg p-6 shadow">
            <h1 class="text-3xl font-bold mb-4">{{ product.title }}</h1>
            
            <div class="mb-4">
                <span class="text-sm text-gray-600">ë¸Œëœë“œ</span>
                <p class="text-lg font-semibold">{{ product.brand.name }}</p>
            </div>
            
            <div class="mb-4">
                <span class="text-sm text-gray-600">ì¹´í…Œê³ ë¦¬</span>
                <p class="text-lg">{{ product.category.name }}</p>
            </div>

            <div class="border-t border-b py-4 my-4">
                <div class="flex items-end gap-3 mb-2">
                    <span class="text-4xl font-bold text-red-600">
                        {{ product.price|floatformat:0|intcomma }}ì›
                    </span>
                    {% if product.original_price and product.original_price > product.price %}
                    <span class="text-xl text-gray-500 line-through">
                        {{ product.original_price|floatformat:0|intcomma }}ì›
                    </span>
                    {% endif %}
                </div>
                {% if product.discount_rate > 0 %}
                <p class="text-xl text-green-600 font-bold">
                    ğŸ’° {{ product.discount_rate }}% í• ì¸
                </p>
                {% endif %}
            </div>

            <!-- ìƒí’ˆ ì†ì„± -->
            <div class="mb-6">
                <h3 class="font-semibold mb-3">ìƒí’ˆ ì •ë³´</h3>
                <div class="grid grid-cols-2 gap-2">
                    {% if product.material_composition %}
                    <div class="col-span-2 bg-blue-50 px-3 py-2 rounded">
                        <span class="text-sm text-gray-600">ì†Œì¬ êµ¬ì„±:</span>
                        <span class="text-sm font-medium ml-2">{{ product.material_composition }}</span>
                    </div>
                    {% endif %}
                    
                    {% if product.down_ratio %}
                    <div class="bg-gray-50 px-3 py-2 rounded">
                        <span class="text-sm text-gray-600">ë‹¤ìš´ ë¹„ìœ¨:</span>
                        <span class="text-sm font-medium ml-2">{{ product.down_ratio }}</span>
                    </div>
                    {% endif %}
                    
                    {% if product.fill_power %}
                    <div class="bg-gray-50 px-3 py-2 rounded">
                        <span class="text-sm text-gray-600">í•„íŒŒì›Œ:</span>
                        <span class="text-sm font-medium ml-2">{{ product.fill_power }}FP</span>
                    </div>
                    {% endif %}
                    
                    {% if product.fit %}
                    <div class="bg-gray-50 px-3 py-2 rounded">
                        <span class="text-sm text-gray-600">í•:</span>
                        <span class="text-sm font-medium ml-2">{{ product.fit }}</span>
                    </div>
                    {% endif %}
                    
                    {% if product.shell %}
                    <div class="bg-gray-50 px-3 py-2 rounded">
                        <span class="text-sm text-gray-600">ê²‰ê°:</span>
                        <span class="text-sm font-medium ml-2">{{ product.shell }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- êµ¬ë§¤ ë²„íŠ¼ -->
            <div class="space-y-3">
                <a href="/api/out/?productId={{ product.id }}&subId=detail-{{ product.brand.slug }}-{{ product.category.slug }}"
                   target="_blank"
                   class="block w-full bg-blue-600 text-white text-center py-4 rounded-lg hover:bg-blue-700 font-bold text-lg">
                    ğŸ›’ êµ¬ë§¤í•˜ê¸°
                </a>
                
                {% if not product.in_stock %}
                <p class="text-red-600 text-center">âš ï¸ í’ˆì ˆ ìƒí’ˆì…ë‹ˆë‹¤</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- AI ê¸°ëŠ¥ ì„¹ì…˜ -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
        <!-- ì§ˆê° ìƒì„± -->
        <div class="bg-white rounded-lg p-6 shadow">
            <div class="flex items-center mb-4">
                <span class="text-3xl mr-3">ğŸ”¬</span>
                <div>
                    <h2 class="text-2xl font-bold">ì‹¤ì œ ì†Œì¬ ê¸°ë°˜ ì§ˆê° ìƒì„¸í™”</h2>
                    <p class="text-sm text-gray-600">AIê°€ ì´ ìƒí’ˆì˜ ì§ˆê°ì„ ê·¹ë„ë¡œ í™•ëŒ€í•˜ì—¬ í‘œí˜„í•©ë‹ˆë‹¤</p>
                </div>
            </div>

            {% if has_material %}
            <div class="mb-4 bg-blue-50 p-3 rounded">
                <p class="text-sm text-gray-700">
                    <strong>ì†Œì¬:</strong> {{ product.material_composition }}
                </p>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">í’ˆì§ˆ ë ˆë²¨</label>
                <select id="qualitySelect" class="w-full border rounded px-3 py-2">
                    <option value="high">High - 16K í•´ìƒë„, ê·¹ë„ë¡œ ìƒì„¸í•œ ì„¬ìœ  íŒ¨í„´</option>
                    <option value="medium">Medium - 8K í•´ìƒë„, ìƒì„¸í•œ ì§ˆê°</option>
                    <option value="low">Low - ê¸°ë³¸ ì§ˆê°</option>
                </select>
            </div>

            <button onclick="generateTexture()" id="textureBtn" 
                    class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 font-semibold">
                ğŸ¨ ìƒì„¸ ì§ˆê° ìƒì„±í•˜ê¸°
            </button>

            <div id="textureLoading" class="hidden mt-4 text-center">
                <div class="animate-pulse">
                    <p class="text-purple-600 font-semibold">â³ ì§ˆê° ì´ë¯¸ì§€ ìƒì„± ì¤‘...</p>
                    <p class="text-sm text-gray-600">(ì•½ 5-15ì´ˆ ì†Œìš”)</p>
                </div>
            </div>

            <div id="textureResult" class="hidden mt-4">
                <img id="textureImage" class="w-full rounded-lg" alt="ìƒì„±ëœ ì§ˆê°">
                <div class="mt-3 p-3 bg-gray-50 rounded">
                    <p class="text-sm text-gray-700"><strong>ì„¤ëª…:</strong> <span id="textureDesc"></span></p>
                    <p class="text-xs text-gray-600 mt-1">Model: FLUX.1-dev (Hugging Face)</p>
                </div>
            </div>
            {% else %}
            <div class="bg-yellow-50 border border-yellow-200 rounded p-4 text-sm text-yellow-800">
                âš ï¸ ì´ ìƒí’ˆì€ ì†Œì¬ ì •ë³´ê°€ ì—†ì–´ ì§ˆê° ìƒì„±ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.
            </div>
            {% endif %}
        </div>

        <!-- ìœ ì‚¬ ìƒí’ˆ ì¶”ì²œ -->
        <div class="bg-white rounded-lg p-6 shadow">
            <div class="flex items-center mb-4">
                <span class="text-3xl mr-3">ğŸ‘”</span>
                <div>
                    <h2 class="text-2xl font-bold">ë¹„ìŠ·í•œ ìŠ¤íƒ€ì¼ ì¶”ì²œ</h2>
                    <p class="text-sm text-gray-600">ê°™ì€ ì¹´í…Œê³ ë¦¬ì—ì„œ ìœ ì‚¬í•œ ë””ìì¸ì„ ì°¾ìŠµë‹ˆë‹¤</p>
                </div>
            </div>

            {% if has_embedding %}
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">ì¶”ì²œ ê°œìˆ˜</label>
                <select id="limitSelect" class="w-full border rounded px-3 py-2">
                    <option value="5">5ê°œ</option>
                    <option value="10" selected>10ê°œ</option>
                    <option value="20">20ê°œ</option>
                </select>
            </div>

            <button onclick="findSimilar()" id="similarBtn"
                    class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 font-semibold">
                ğŸ” ë¹„ìŠ·í•œ ìŠ¤íƒ€ì¼ ì°¾ê¸°
            </button>

            <div id="similarLoading" class="hidden mt-4 text-center">
                <div class="animate-pulse">
                    <p class="text-indigo-600 font-semibold">â³ ê²€ìƒ‰ ì¤‘...</p>
                </div>
            </div>

            <div id="similarResult" class="hidden mt-4">
                <p class="text-sm font-semibold mb-3" id="similarCount"></p>
                <div id="similarProducts" class="space-y-3 max-h-96 overflow-y-auto"></div>
            </div>
            {% else %}
            <div class="bg-yellow-50 border border-yellow-200 rounded p-4 text-sm text-yellow-800">
                âš ï¸ ì´ ìƒí’ˆì€ ì´ë¯¸ì§€ ë¶„ì„ì´ ì™„ë£Œë˜ì§€ ì•Šì•„ ì¶”ì²œì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
const PRODUCT_ID = '{{ product.id }}';
const API_BASE = window.location.origin + '/api/recommendations';

// CSRF í† í° ê°€ì ¸ì˜¤ê¸°
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// ì§ˆê° ìƒì„±
async function generateTexture() {
    const quality = document.getElementById('qualitySelect').value;
    const btn = document.getElementById('textureBtn');
    const loading = document.getElementById('textureLoading');
    const result = document.getElementById('textureResult');

    btn.disabled = true;
    loading.classList.remove('hidden');
    result.classList.add('hidden');

    try {
        const response = await fetch(`${API_BASE}/v2/generate-texture/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({product_id: PRODUCT_ID, quality: quality})
        });

        const data = await response.json();
        
        if (data.success) {
            document.getElementById('textureImage').src = 'data:image/png;base64,' + data.texture_image;
            document.getElementById('textureDesc').textContent = data.description;
            result.classList.remove('hidden');
        } else {
            alert('ì§ˆê° ìƒì„± ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
    } catch (error) {
        alert('ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
    } finally {
        btn.disabled = false;
        loading.classList.add('hidden');
    }
}

// ìœ ì‚¬ ìƒí’ˆ ì°¾ê¸°
async function findSimilar() {
    const limit = document.getElementById('limitSelect').value;
    const btn = document.getElementById('similarBtn');
    const loading = document.getElementById('similarLoading');
    const result = document.getElementById('similarResult');

    btn.disabled = true;
    loading.classList.remove('hidden');
    result.classList.add('hidden');

    try {
        const response = await fetch(`${API_BASE}/v2/similar-images/${PRODUCT_ID}/?limit=${limit}`);
        const data = await response.json();

        if (data.similar_products && data.similar_products.length > 0) {
            document.getElementById('similarCount').textContent = 
                `ì´ ${data.total_count}ê°œì˜ ìœ ì‚¬ ìƒí’ˆì„ ì°¾ì•˜ìŠµë‹ˆë‹¤`;
            
            const container = document.getElementById('similarProducts');
            container.innerHTML = '';

            data.similar_products.forEach(p => {
                const card = document.createElement('div');
                card.className = 'flex gap-3 p-3 border rounded hover:bg-gray-50';
                card.innerHTML = `
                    <img src="${p.image_url}" alt="${p.name}" class="w-20 h-20 object-cover rounded">
                    <div class="flex-1">
                        <p class="font-semibold text-sm line-clamp-2">${p.name}</p>
                        <p class="text-xs text-gray-600">${p.brand}</p>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-sm font-bold text-red-600">${p.final_price.toLocaleString()}ì›</span>
                            <span class="text-xs bg-purple-100 text-purple-800 px-2 py-0.5 rounded">${p.style_match}</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">ìœ ì‚¬ë„: ${(p.similarity_score * 100).toFixed(1)}%</p>
                    </div>
                `;
                container.appendChild(card);
            });

            result.classList.remove('hidden');
        } else {
            alert('ìœ ì‚¬í•œ ìƒí’ˆì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤');
        }
    } catch (error) {
        alert('ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
    } finally {
        btn.disabled = false;
        loading.classList.add('hidden');
    }
}
</script>
{% endblock %}
